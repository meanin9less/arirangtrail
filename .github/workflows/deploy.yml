
# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Build and Push Docker Images

# ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches:
      - main # backend ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

# ì‹¤í–‰ë  ì‘ì—… ì •ì˜
jobs:
  # ë¹Œë“œ ë° í‘¸ì‹œ ì‘ì—…
  build_and_push:
    # ì‹¤í–‰ í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest

    # ì‘ì—… ë‹¨ê³„
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Docker Buildx ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. DockerHub ë¡œê·¸ì¸
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. MySQL Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push MySQL Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./db/mysql
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/arirangmysql:latest
          no-cache: true

      # 5. Mongo Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Mongo Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./db/mongo
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/arirangmongo:latest
          no-cache: true

      # 6. Redis Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Redis Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./db/redis
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/arirangredis:latest
          no-cache: true

      # 7. Frontend Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/arirangfrontend:latest
          no-cache: true

      # 8. Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ================== ğŸ‘‡ğŸ‘‡ğŸ‘‡ ì—¬ê¸°ë¶€í„° ì¶”ê°€ ğŸ‘‡ğŸ‘‡ğŸ‘‡ ==================
      - name: ğŸ•µï¸ Check files in workspace
        run: |
          echo "--- Current Directory Content ---"
          ls -la
          echo ""
          echo "--- Content of build.gradle ---"
          cat build.gradle
          echo "-------------------------------"
      # ================== ğŸ‘†ğŸ‘†ğŸ‘† ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ ğŸ‘†ğŸ‘†ğŸ‘† ==================

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/arirangbackend:latest
          no-cache: true

  # ë°°í¬ ì‘ì—…
  deploy:
    # build_and_push ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      # EC2ì— SSHë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Docker pull and run
        uses: appleboy/ssh-action@v0.1.10
        with:
          username: ubuntu
          host: ${{ secrets.LIVE_SERVER_IP }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            if [ "$(sudo docker ps -a -q -f name=arirangmysql)" ]; then sudo docker rm -f arirangmysql; fi
            if [ "$(sudo docker ps -a -q -f name=arirangmongo)" ]; then sudo docker rm -f arirangmongo; fi
            if [ "$(sudo docker ps -a -q -f name=arirangredis)" ]; then sudo docker rm -f arirangredis; fi
            if [ "$(sudo docker ps -a -q -f name=arirangbackend)" ]; then sudo docker rm -f arirangbackend; fi
            if [ "$(sudo docker ps -a -q -f name=arirangfrontend)" ]; then sudo docker rm -f arirangfrontend; fi

            # ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ
            if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/arirangmysql)" ]; then sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/arirangmysql; fi
            if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/arirangmongo)" ]; then sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/arirangmongo; fi
            if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/arirangredis)" ]; then sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/arirangredis; fi
            if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/arirangbackend)" ]; then sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/arirangbackend; fi
            if [ "$(sudo docker images -q ${{ secrets.DOCKERHUB_USERNAME }}/arirangfrontend)" ]; then sudo docker rmi -f ${{ secrets.DOCKERHUB_USERNAME }}/arirangfrontend; fi

            # DockerHubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/arirangmysql
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/arirangmongo
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/arirangredis
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/arirangbackend
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/arirangfrontend

            # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d -p 3308:3306 --name arirangmysql -v arirangmysql_volume:/var/lib/mysql ${{ secrets.DOCKERHUB_USERNAME }}/arirangmysql
            sudo docker run -d -p 27017:27017 --name arirangmongo -v arirangmongo_volume:/data/db ${{ secrets.DOCKERHUB_USERNAME }}/arirangmongo
            sudo docker run -d -p 6379:6379 --name arirangredis -v arirangredis_volume:/data ${{ secrets.DOCKERHUB_USERNAME }}/arirangredis redis-server --requirepass ${{ secrets.REDIS_PASSWORD }}
            
            # ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ ì—°ê²°í•  ëŒ€ìƒë“¤ì˜ id ë° íŒ¨ìŠ¤ì›Œë“œ ë³€ìˆ˜ ì„¤ì • ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d -p 8080:8080 --name arirangbackend \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e GOOGLE_CLIENT_ID=${{secrets.GOOGLE_CLIENT_ID}} \
            -e GOOGLE_CLIENT_SECRET=${{secrets.GOOGLE_CLIENT_SECRET}} \
            -e NAVER_CLIENT_ID=${{secrets.NAVER_CLIENT_ID}} \
            -e NAVER_CLIENT_SECRET=${{secrets.NAVER_CLIENT_SECRET}} \
            -e KAKAO_CLIENT_ID=${{secrets.KAKAO_CLIENT_ID}} \
            -e KAKAO_CLIENT_SECRET=${{secrets.KAKAO_CLIENT_SECRET}} \
            -e AWS_ACCESS_KEY_ID=${{secrets.AWS_ACCESS_KEY_ID}} \
            -e AWS_SECRET_ACCESS_KEY=${{secrets.AWS_SECRET_ACCESS_KEY}} \
            -e REDIS_PASSWORD=${{secrets.REDIS_PASSWORD}} \
            ${{ secrets.DOCKERHUB_USERNAME }}/arirangbackend
            sudo docker run -d -p 80:80 --name arirangfrontend ${{ secrets.DOCKERHUB_USERNAME }}/arirangfrontend
